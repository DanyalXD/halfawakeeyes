<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analytics Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f8f9fa;
      color: #212529;
    }

    .table-responsive {
      overflow-x: auto;
    }

    #dashboard {
      display: none;
    }

    .nav-tabs .nav-link.active {
      background-color: #0d6efd;
      color: #fff;
    }

    /* ‚úÖ Improve table appearance */
    table {
      table-layout: fixed;
      word-wrap: break-word;
      font-size: 0.9rem;
    }

    th, td {
      vertical-align: middle !important;
    }

    th {
      text-transform: capitalize;
      white-space: nowrap;
    }

    td {
      white-space: normal;
    }

    /* Long text wrapping */
    td:nth-child(n+3) {
      word-break: break-all;
    }

    /* Reduce horizontal scroll bar prominence */
    ::-webkit-scrollbar {
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: #999;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
  </style>
</head>

<body class="bg-light text-dark">
  <div class="container py-5">
    <!-- Login -->
    <div id="login">
      <h1 class="mb-4 text-center">üîê Enter Credentials</h1>
      <form id="login-form" class="text-center">
        <div class="mb-3">
          <input type="text" id="username" class="form-control" placeholder="Username" required />
        </div>
        <div class="mb-3">
          <input type="password" id="password" class="form-control" placeholder="Password" required />
        </div>
        <button type="submit" class="btn btn-primary">Unlock</button>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
      <h1 class="mb-4 text-center text-md-start">üìä Analytics Dashboard</h1>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
          <a class="nav-link active" href="#" data-collection="site-actions">Site Actions</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-collection="ad-tracking">Ad Tracking</a>
        </li>
      </ul>

      <!-- Summary -->
      <div class="mb-3">
        <h5>Event Counts</h5>
        <div id="summary" class="mb-4"></div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-dark" id="log-head"></thead>
          <tbody id="log-rows"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </div>
  </div>

  <!-- ‚úÖ Script at bottom -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAv7G28uXxlQNG_HMLbBkuz4xseXzOzm4Y",
      authDomain: "half-awake-eyes.firebaseapp.com",
      projectId: "half-awake-eyes"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const PAGE_SIZE = 10;
    let logs = [];
    let currentCollection = "site-actions";
    let dynamicFields = [];

    async function loadLogs(collectionName) {
      try {
        let querySnapshot;
        try {
          const q = query(collection(db, collectionName), orderBy("timestamp", "desc"));
          querySnapshot = await getDocs(q);
        } catch {
          console.warn(`‚ö†Ô∏è ${collectionName} missing timestamp ‚Äî loading unordered`);
          querySnapshot = await getDocs(collection(db, collectionName));
        }

        logs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (logs.length > 0) {
          const fieldSet = new Set();
          logs.forEach(l => Object.keys(l).forEach(f => fieldSet.add(f)));
          // ‚úÖ Sort fields alphabetically for consistent order
          dynamicFields = Array.from(fieldSet).filter(f => f !== "id").sort((a, b) => a.localeCompare(b));
        } else {
          dynamicFields = [];
        }

        renderTable(1);
        renderSummary();
      } catch (e) {
        console.error("Error loading logs:", e);
        alert("Failed to load data from Firestore. Check console for details.");
      }
    }

    function renderTable(page) {
      const head = document.getElementById("log-head");
      const body = document.getElementById("log-rows");
      head.innerHTML = "";
      body.innerHTML = "";

      if (logs.length === 0) {
        body.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No data found.</td></tr>`;
        return;
      }

      const headerRow = document.createElement("tr");
      dynamicFields.forEach(field => {
        const th = document.createElement("th");
        th.textContent = field;
        headerRow.appendChild(th);
      });
      head.appendChild(headerRow);

      const start = (page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageLogs = logs.slice(start, end);

      pageLogs.forEach(data => {
        const row = document.createElement("tr");
        dynamicFields.forEach(field => {
          const td = document.createElement("td");
          let value = data[field];
          if (field === "timestamp" && value?.seconds) {
            value = new Date(value.seconds * 1000).toLocaleString();
          }
          td.textContent = value ?? "-";
          row.appendChild(td);
        });
        body.appendChild(row);
      });

      renderPagination(page);
    }

    function renderPagination(currentPage) {
      const pageCount = Math.ceil(logs.length / PAGE_SIZE);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      for (let i = 1; i <= pageCount; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.addEventListener("click", (e) => {
          e.preventDefault();
          renderTable(i);
        });
        pagination.appendChild(li);
      }
    }

    function renderSummary() {
      const summary = document.getElementById("summary");
      if (logs.length === 0) {
        summary.innerHTML = `<span class="text-muted">No data.</span>`;
        return;
      }

      const summaryField = dynamicFields.includes("action")
        ? "action"
        : dynamicFields[0];

      const counts = {};
      logs.forEach(l => {
        const val = l[summaryField] ?? "Unknown";
        counts[val] = (counts[val] || 0) + 1;
      });

      summary.innerHTML = Object.entries(counts)
        .map(([key, count]) => `<span class="badge bg-primary me-2">${key}: ${count}</span>`)
        .join(" ");
    }

    function showDashboard() {
      document.getElementById("login").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      loadLogs(currentCollection);
    }

    function setActiveCollection(name) {
      currentCollection = name;
      document.querySelectorAll(".nav-link").forEach(link => link.classList.remove("active"));
      document.querySelector(`[data-collection="${name}"]`).classList.add("active");

      document.getElementById("log-head").innerHTML = "";
      document.getElementById("log-rows").innerHTML = `
        <tr><td colspan="5" class="text-center text-muted">Loading ${name}...</td></tr>
      `;

      loadLogs(name);
    }

    window.addEventListener("DOMContentLoaded", () => {
      console.log("Attaching tab listeners...");
      const form = document.getElementById("login-form");

      const lastLogin = localStorage.getItem("dashboardLogin");
      if (lastLogin && Date.now() - parseInt(lastLogin, 10) < 24 * 60 * 60 * 1000) {
        showDashboard();
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const inputUsername = document.getElementById("username").value;
        const inputPassword = document.getElementById("password").value;

        const usersRef = collection(db, "users");
        const q = query(usersRef, where("username", "==", inputUsername), where("password", "==", inputPassword));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          localStorage.setItem("dashboardLogin", Date.now().toString());
          showDashboard();
        } else {
          alert("Incorrect username or password");
        }
      });

      document.querySelectorAll(".nav-link").forEach(link => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const name = e.target.getAttribute("data-collection");
          setActiveCollection(name);
        });
      });
    });
  </script>
</body>
</html>
